<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Matrix Drone Defense - GAME MODE</title>
<style>
html, body { margin: 0; height: 100%; background: black; overflow: hidden; cursor: none; }
canvas { display: block; }
#hud {
  position: absolute;
  top: 10px;
  left: 10px;
  color: #00ffcc;
  font-family: monospace;
  font-size: 18px;
  z-index: 10;
}
#magnetBarContainer {
  position: absolute;
  top: 40px;
  left: 10px;
  width: 150px;
  height: 12px;
  background: rgba(64,224,208,0.2);
  border: 1px solid #00ffcc;
}
#magnetBar {
  width: 100%;
  height: 100%;
  background: #00ffcc;
}
</style>
</head>
<body>
<div id="hud">Score: 0 | Lives: 3</div>
<div id="magnetBarContainer"><div id="magnetBar"></div></div>
<script>
'use strict';
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");
document.body.appendChild(canvas);
const hud = document.getElementById('hud');
const magnetBar = document.getElementById('magnetBar');

let cw, ch;
const resize = () => { cw = canvas.width = window.innerWidth; ch = canvas.height = window.innerHeight; };
window.addEventListener("resize", resize);
resize();

const matrixChars = '01';
let drones = [], totalDrones = 120;
let eliteDrones = [];
let lastEliteSpawnScore = 0;
let mouse = { x: cw/2, y: ch/2, inside: true };
let score = 0, lives = 3, gameOver = false;

// Player triangle
const player = { x: cw/2, y: ch - 60, w: 36, h: 22, speed: 8 };

// Shooting
const bullets = [];
const BULLET_SPEED = 12;
let canShoot = true;
const SHOOT_COOLDOWN = 150;

// Difficulty
let speedMultiplier = 0.05;
const MAX_SPEED = 3.0;

// Magnet/M key logic
let magnetActive = false;
let magnetCooldown = false;
let magnetHoldTime = 0; // How long M has been held
const MAGNET_MAX_HOLD = 10; // seconds
const MAGNET_COOLDOWN = 3;  // seconds
let magnetRefillTime = 0;   // seconds remaining to refill during cooldown

// Key states
const keys = {};
window.addEventListener('keydown', e => { 
  keys[e.code] = true; 
  if(e.key.toLowerCase() === 'r' && gameOver) restart(); 
});
window.addEventListener('keyup', e => { 
  keys[e.code] = false; 
  if(e.key.toLowerCase() === 'm') magnetActive = false; 
});

// Mouse
window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; mouse.inside = true; });
window.addEventListener('mouseleave', () => mouse.inside = false);

function shoot(){
  if(gameOver || !canShoot) return;
  bullets.push({ x: player.x, y: player.y - player.h - 6 });
  canShoot = false;
  setTimeout(()=>canShoot=true, SHOOT_COOLDOWN);
}

function resetDrone(d, init=false){
  d.x = Math.random()*cw;
  d.y = Math.random()*(ch*0.35)-ch*0.2;
  d.size = 18 + Math.random()*12;
  d.char = matrixChars[Math.floor(Math.random()*matrixChars.length)];
  d.flipTimer = Math.random()*120;
  d.vx = (Math.random()-0.5)*0.6;
  d.vy = (Math.random()-0.5)*0.6;
  d.speedBoost = 1;
  if(init){ d.x = cw/2 + (Math.random()-0.5)*cw*0.6; d.y = ch*0.15 + Math.random()*ch*0.2; }
}

for(let i=0;i<totalDrones;i++){ let d = {}; resetDrone(d,true); drones.push(d); }

function drawPlayer(){
  ctx.strokeStyle = 'rgba(0,255,255,0.9)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(player.x, player.y - player.h/1.2);
  ctx.lineTo(player.x - player.w/2, player.y + player.h/1.5);
  ctx.lineTo(player.x + player.w/2, player.y + player.h/1.5);
  ctx.closePath();
  ctx.stroke();
}

function drawCrosshair(){
  if(!mouse.inside) return;
  ctx.strokeStyle='#00ffcc';
  ctx.lineWidth=1.5;
  ctx.beginPath();
  ctx.moveTo(mouse.x-12, mouse.y); ctx.lineTo(mouse.x+12, mouse.y);
  ctx.moveTo(mouse.x, mouse.y-12); ctx.lineTo(mouse.x, mouse.y+12);
  ctx.stroke();
}

function drawHUD(){ hud.textContent=`Score: ${score} | Lives: ${lives}`; }

function restart(){ 
  score = 0; 
  lives = 3; 
  gameOver = false; 
  speedMultiplier = 0.05; 
  bullets.length = 0; 
  player.x = cw / 2;
  player.y = ch - 60;
  mouse.x = cw/2; mouse.y = ch/2; mouse.inside = true;
  drones.forEach(d => resetDrone(d,true)); 
  eliteDrones.length = 0;
  lastEliteSpawnScore = 0;
  magnetCooldown = false;
  magnetActive = false;
  magnetHoldTime = 0;
  magnetRefillTime = 0;
}

function drawGameOver(){
  ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(0,0,cw,ch);
  ctx.fillStyle='#ff4444'; ctx.font='48px monospace'; ctx.textAlign='center'; ctx.fillText('GAME OVER',cw/2,ch/2-20);
  ctx.fillStyle='#00ffcc'; ctx.font='24px monospace'; ctx.fillText(`Score: ${score}`,cw/2,ch/2+20);
  ctx.font='16px monospace'; ctx.fillText(`Press R to restart`,cw/2,ch/2+58);
}

function updateAndDrawDrones(delta){
  for(let d of drones){
    d.flipTimer-=delta;
    if(d.flipTimer<=0){ d.char = matrixChars[Math.floor(Math.random()*matrixChars.length)]; d.flipTimer=30+Math.random()*160; }

    const size = d.size;
    ctx.font=`${size}px monospace`;
    ctx.fillStyle=`rgba(64,224,208,${0.6+Math.random()*0.35})`;
    ctx.fillText(d.char,d.x,d.y);

    d.vx += (Math.sin(Date.now()*0.001 + d.x)*0.002);
    d.vy += (Math.cos(Date.now()*0.001 + d.y)*0.002);

    const dx = (magnetActive && !magnetCooldown && mouse.inside ? mouse.x : player.x) - d.x;
    const dy = (magnetActive && !magnetCooldown && mouse.inside ? mouse.y : player.y) - d.y;
    const dist = Math.hypot(dx,dy)||1;
    d.vx += dx/dist*0.02*(1+speedMultiplier)*d.speedBoost;
    d.vy += dy/dist*0.02*(1+speedMultiplier)*d.speedBoost;

    d.x += d.vx;
    d.y += d.vy;
    d.vx*=0.93; d.vy*=0.93;

    // Bullet collision
    for(let i=bullets.length-1;i>=0;i--){
      const b=bullets[i];
      const distB=Math.hypot(b.x-d.x,b.y-d.y);
      if(distB<Math.max(12,size*0.6)){
        bullets.splice(i,1);
        score++;
        d.speedBoost = Math.min(d.speedBoost + 1, 5);
        speedMultiplier = Math.min(speedMultiplier + 0.01, MAX_SPEED);
        resetDrone(d);
        break;
      }
    }

    const distP = Math.hypot(d.x - player.x, d.y - (player.y - player.h/4));
    if(distP<18){ lives--; if(lives<=0) gameOver=true; resetDrone(d); }

    if(d.x<-50 || d.x>cw+50 || d.y<-50 || d.y>ch+50) resetDrone(d);
  }
}

function spawnEliteDrone() {
  const side = Math.floor(Math.random() * 4);
  let x, y;
  if (side === 0) { x = Math.random() * cw; y = -40; }
  else if (side === 1) { x = Math.random() * cw; y = ch + 40; }
  else if (side === 2) { x = -40; y = Math.random() * ch; }
  else { x = cw + 40; y = Math.random() * ch; }
  eliteDrones.push({ x, y, vx: 0, vy: 0, size: 28 });
}

function updateAndDrawEliteDrones() {
  for (let i = eliteDrones.length - 1; i >= 0; i--) {
    const d = eliteDrones[i];
    const dx = player.x - d.x;
    const dy = player.y - d.y;
    const dist = Math.hypot(dx, dy) || 1;
    d.vx += (dx / dist) * 0.4;
    d.vy += (dy / dist) * 0.4;
    d.x += d.vx;
    d.y += d.vy;
    d.vx *= 0.9;
    d.vy *= 0.9;

    ctx.strokeStyle = '#ff2222';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(d.x, d.y - d.size / 1.3);
    ctx.lineTo(d.x - d.size / 2, d.y + d.size / 1.2);
    ctx.lineTo(d.x + d.size / 2, d.y + d.size / 1.2);
    ctx.closePath();
    ctx.stroke();

    for (let b = bullets.length - 1; b >= 0; b--) {
      const bullet = bullets[b];
      const distB = Math.hypot(bullet.x - d.x, bullet.y - d.y);
      if (distB < d.size) {
        bullets.splice(b, 1);
        eliteDrones.splice(i, 1);
        score++;
        break;
      }
    }

    const distP = Math.hypot(d.x - player.x, d.y - player.y);
    if (distP < d.size) {
      eliteDrones.splice(i, 1);
      lives--;
      if (lives <= 0) gameOver = true;
    }
  }
}

function handlePlayerMovement(){
  if(keys['ArrowLeft']) player.x -= player.speed;
  if(keys['ArrowRight']) player.x += player.speed;
  if(keys['ArrowUp']) player.y -= player.speed;
  if(keys['ArrowDown']) player.y += player.speed;
  if(keys['Space']) shoot();
  player.x = Math.max(0, Math.min(cw, player.x));
  player.y = Math.max(0, Math.min(ch, player.y));
}

// Magnet bar update
function updateMagnetBar(delta){
  const dt = delta / 1000; // convert ms to s
  if(keys['KeyM'] && !magnetCooldown){
    magnetActive = true;
    magnetHoldTime += dt;
    if(magnetHoldTime >= MAGNET_MAX_HOLD){
      magnetCooldown = true;
      magnetActive = false;
      magnetRefillTime = MAGNET_COOLDOWN;
      magnetHoldTime = 0;
    }
  } else {
    magnetActive = false;
    if(!magnetCooldown){
      magnetHoldTime -= dt*2; // refill faster when released
      if(magnetHoldTime<0) magnetHoldTime=0;
    }
  }

  if(magnetCooldown){
    magnetRefillTime -= dt;
    if(magnetRefillTime <=0){
      magnetCooldown = false;
      magnetRefillTime = 0;
    }
  }

  // Update bar width
  let fillPercent = 0;
  if(magnetCooldown){
    fillPercent = 1 - (magnetRefillTime / MAGNET_COOLDOWN);
  } else {
    fillPercent = magnetHoldTime / MAGNET_MAX_HOLD;
  }
  magnetBar.style.width = `${fillPercent*100}%`;
}

// Main loop
let lastTime = performance.now();
function loop(now){
  const delta = now-lastTime; lastTime=now;

  ctx.fillStyle='rgba(0,0,0,0.12)';
  ctx.fillRect(0,0,cw,ch);

  if(gameOver){ drawGameOver(); drawHUD(); requestAnimationFrame(loop); return; }

  handlePlayerMovement();
  bullets.forEach((b,i)=>{ 
    b.y-=BULLET_SPEED; 
    ctx.fillStyle='rgba(0,255,255,0.95)'; 
    ctx.fillRect(b.x-1,b.y,2,10); 
    if(b.y<-20) bullets.splice(i,1); 
  });

  updateAndDrawDrones(delta);

  if (score % 10 === 0 && score !== 0 && score !== lastEliteSpawnScore) {
    spawnEliteDrone();
    lastEliteSpawnScore = score;
  }

  updateAndDrawEliteDrones();

  drawPlayer(); 
  drawCrosshair();
  drawHUD();

  updateMagnetBar(delta);

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>
</body>
</html>